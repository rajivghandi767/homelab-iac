- name: Layer 1 - Foundation (System, Docker Config & Dependencies)
  hosts: all
  become: yes

  vars:
    system_user: "dietpi" #change if OS changes
    
    # System Packages
    required_packages:
      - git
      - curl
      - wget
      - htop
      - make
      - unzip
      - dnsutils
      - gpg
      - software-properties-common
      - python3-docker        # For managing Docker containers
      - python3-requests      # For GCS downloads
      - python3-google-auth   # For GCS authentication

    # Docker Networks
    docker_networks:
      - core
      - database
      - monitoring
      - media
      - portfolio
      - trivia

  tasks:
    # --- PHASE 1: SYSTEM PREP ---
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install System Prerequisites
      apt:
        name: "{{ required_packages }}"
        state: present

    - name: Ensure Local Bin Directory exists
      file:
        path: "/home/{{ system_user }}/.local/bin"
        state: directory
        owner: "{{ system_user }}"
        mode: '0755'

    # --- PHASE 2: TERRAFORM ---
    - name: Download HashiCorp GPG Key
      get_url:
        url: https://apt.releases.hashicorp.com/gpg
        dest: /usr/share/keyrings/hashicorp-archive-keyring.gpg

    - name: Add HashiCorp Repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
        state: present
        filename: hashicorp

    - name: Install Terraform
      apt:
        name: terraform
        state: present

    # --- PHASE 3: SAFE DOCKER CONFIG ---
    - name: Add User to Docker Group
      user:
        name: "{{ system_user }}"
        groups: docker
        append: yes

    - name: Create Docker Networks
      docker_network:
        name: "{{ item }}"
        driver: bridge
      loop: "{{ docker_networks }}"

    # --- PHASE 3.5: CONFIGURATION & SECRETS ---
    - name: Load Global Config and Secrets
      include_vars:
        dir: group_vars/all
        extensions:
          - yml

    - name: Generate Environment Files from Templates
      template:
        src: "../services/{{ item.path }}/.env.j2"
        dest: "/opt/homelab/services/{{ item.path }}/.env"
        mode: '0600'
      loop:
        - { path: 'core/unifi-controller' }
        - { path: 'core/pihole' }
        - { path: 'core/watchtower' }
        - { path: 'database/postgres-core' }
        - { path: 'database/pgadmin' }
        - { path: 'monitoring' }
      tags: ['env_files']

    # --- PHASE 4: DIRECTORY STRUCTURE ---
    - name: Create Homelab Directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: "{{ system_user }}"
        group: "{{ system_user }}"
      loop:
        - /opt/homelab-iac
        - /opt/homelab-iac/backups
        - /opt/homelab-iac/secrets

    # --- PHASE 5: BACKUP AUTOMATION ---
    - name: Ensure Scripts Directory exists
      file:
        path: "/opt/homelab-iac/scripts"
        state: directory
        mode: '0755'
        owner: "{{ system_user }}"
        group: "{{ system_user }}"

    - name: Install Backup Script
      copy:
        src: "../scripts/backup_volumes.sh"
        dest: "/opt/homelab-iac/scripts/backup_volumes.sh"
        mode: '0755'
        owner: "{{ system_user }}"
        group: "{{ system_user }}"

    - name: Create Secrets .env for Backup Script
      copy:
        dest: "/opt/homelab-iac/secrets/.env"
        mode: '0600'
        owner: "{{ system_user }}" 
        content: |
          BACKUP_ENCRYPTION_KEY="{{ backup_encryption_passphrase }}"

    - name: Schedule Daily Backup (Cron)
      cron:
        name: "Run Daily Backup"
        minute: "0"
        hour: "4" # Runs at 4:00 AM
        user: "root" # Run as root to allow stopping/starting docker containers
        # CRITICAL: We cd into the dir first so the relative paths (../secrets) in script work
        job: "cd /opt/homelab-iac/scripts && ./backup_volumes.sh >> /var/log/homelab_backup.log 2>&1"